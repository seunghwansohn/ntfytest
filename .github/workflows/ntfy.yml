name: Notify on Issue Events

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up environment
        run: |
          echo "TOPIC_PASSPHRASE=${{ secrets.TOPIC_PASSPHRASE }}" >> .env
          echo "SALT=${{ secrets.SALT }}" >> .env
          echo "MSG_PASSPHRASE=${{ secrets.MSG_PASSPHRASE }}" >> .env
          echo "NTFY_PRIVATE_URL=http://localhost:2586" >> .env
          echo "PRIVATE_TOPIC=hub-internal" >> .env

      - name: Send Notification
        env:
          DEBUG: true
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          REPO_NAME: ${{ github.event.repository.name }}
          EVENT_ACTION: ${{ github.event.action }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          COMMENT_USER: ${{ github.event.comment.user.login }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          TOPIC_NAME="git:${REPO_NAME}"
          
          if [ "${GITHUB_EVENT_NAME}" == "issues" ]; then
            MESSAGE="[Issue ${EVENT_ACTION}] #${ISSUE_NUMBER}: ${ISSUE_TITLE}"
          elif [ "${GITHUB_EVENT_NAME}" == "issue_comment" ]; then
            # Truncate comment body if too long
            COMMENT_PREVIEW=$(echo "${COMMENT_BODY}" | head -n 1 | cut -c 1-100)
            MESSAGE="[Comment created] #${ISSUE_NUMBER} by ${COMMENT_USER}: ${COMMENT_PREVIEW}..."
          else
            MESSAGE="[Event: ${GITHUB_EVENT_NAME}] repository event"
          fi
          
          chmod +x scripts/publish.sh scripts/crypto.sh
          ./scripts/publish.sh "${MESSAGE}" "${TOPIC_NAME}"
